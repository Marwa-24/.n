module.exports = {
	config: {
		name: "groupManager",
		version: "1.0",
		author: "å…ƒ AldÃ©ric-ã‚·ï¸Žï¸Ž",
		description: "GÃ¨re les groupes non confirmÃ©s et les demandes d'accÃ¨s",
		category: "owner",
		guide: {
			en: "   {pn} confirm <threadID> : Confirme un groupe pour utiliser le bot\n" +
				"   {pn} ban <threadID> : Interdit dÃ©finitivement un groupe d'utiliser le bot"
		},
	},

	langs: {
		en: {
			noPermission: "You don't have permission to use this command.",
			groupConfirmed: "âœ… Le groupe avec l'ID [%1] a Ã©tÃ© confirmÃ© avec succÃ¨s.",
			groupBanned: "â›” Le groupe avec l'ID [%1] a Ã©tÃ© interdit dÃ©finitivement.",
			invalidID: "âŒ Veuillez spÃ©cifier un threadID valide.",
			groupNotFound: "âŒ Impossible de trouver des informations sur ce groupe.",
			groupUnauthorized: "ðŸ”’ Ce groupe n'est pas autorisÃ© Ã  utiliser ce bot.\nðŸ‘‰ Contactez l'administration pour confirmer l'accÃ¨s.",
		}
	},

	onStart: async function ({ args, threadsData, message, role, event, api, getLang }) {
		// VÃ©rifie si c'est une commande ou un Ã©vÃ©nement de groupe
		if (args.length > 0) {
			// Gestion par commande
			const action = args[0];
			const threadID = args[1];

			if (role < 2) return message.reply(getLang("noPermission"));

			if (!threadID || isNaN(threadID)) {
				return message.reply(getLang("invalidID"));
			}

			const threadData = await threadsData.get(threadID);

			switch (action) {
				case "confirm": {
					// VÃ©rifie si le groupe est dÃ©jÃ  confirmÃ©
					if (threadData?.confirmed) {
						return message.reply(`Le groupe avec l'ID [${threadID}] est dÃ©jÃ  confirmÃ©.`);
					}

					// Ajoute le groupe comme confirmÃ©
					await threadsData.set(threadID, {
						threadID,
						threadName: threadData?.threadName || "Nom inconnu",
						confirmed: true,
						createdAt: Date.now(),
					});

					return message.reply(getLang("groupConfirmed", threadID));
				}

				case "ban": {
					// VÃ©rifie si le groupe existe
					if (!threadData) {
						return message.reply(getLang("groupNotFound"));
					}

					// Bannis le groupe
					await threadsData.set(threadID, {
						banned: true,
					});

					return message.reply(getLang("groupBanned", threadID));
				}

				default:
					return message.reply("Utilisez `confirm` ou `ban` avec un threadID valide.");
			}
		} else {
			// Gestion automatique lorsqu'un groupe ajoute le bot
			const { threadID, isGroup } = event;

			// Ignore les conversations privÃ©es
			if (!isGroup) return;

			// VÃ©rifie si le groupe est confirmÃ©
			const threadData = await threadsData.get(threadID);

			// Si non confirmÃ©, quitte le groupe
			if (!threadData?.confirmed) {
				await api.sendMessage(
					getLang("groupUnauthorized"),
					threadID,
					() => api.removeUserFromGroup(api.getCurrentUserID(), threadID)
				);
			}
		}
	}
};
